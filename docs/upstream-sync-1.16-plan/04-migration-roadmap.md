# 04. 迁移执行路线图

## 1. 总体阶段

1. 阶段 A：工具与基线固化
2. 阶段 B：无冲突文件批量同步
3. 阶段 C：冲突文件分层合并
4. 阶段 D：接口与命令契约补齐
5. 阶段 E：联调验证与收尾

## 2. 阶段明细

## 2.1 阶段 A：工具与基线固化

目标：确保后续每步可重复、可审计。

任务：

1. 实现 `fastools upsync analyze` MVP（见 `02-ai-sync-assistant.md`）
2. 生成首版报告并落盘到 `docs/upstream-sync-1.16-plan/reports/`
3. 确认“自动同步清单”“冲突清单”“接口缺口清单”

退出条件：

- 报告文件可重复生成
- 清单数量与人工抽样一致

## 2.2 阶段 B：无冲突文件批量同步

目标：快速吃掉低风险增量。

任务：

1. 批量同步 `upstream_only_changed` 文件（预计约 74）
2. 每次提交后执行最小构建验证（前端构建 + 启动 smoke）
3. 若出现行为回归，按文件组回退并拆小批次

退出条件：

- 无冲突文件完成同步
- 基础启动、核心页面可用

## 2.3 阶段 C：冲突文件分层合并

目标：解决 23 个交集文件，优先消灭 P0 风险。

执行顺序：

1. P0：`index.html`、`script.js`、`scripts/extensions.js`
2. P1：聊天/世界书/扩展相关主流程文件
3. P2：样式、文案、欢迎页

合并原则：

- 先引入上游行为，再恢复 Tauri 注入点
- 通过最小补丁保留本地能力（不复制整段旧逻辑）
- 每个冲突文件附“合并说明注释”到提交信息或 PR 描述

退出条件：

- 23 个冲突文件全部合并
- Tauri 注入链与上游初始化链同时有效

## 2.4 阶段 D：接口与命令契约补齐

目标：消除 1.16 新增接口缺口。

任务：

1. 新增/补齐前端路由接管（`src/tauri/main/routes/*`）
2. 对应补齐 Rust 命令或明确降级返回
3. 对“不实现的提供商能力”统一返回结构化 `unsupported`，避免前端异常

建议优先级：

1. `/api/chats/group/info`
2. `/api/image-metadata/all`
3. `/api/volcengine/generate-voice`
4. 其余多模态/图像后端接口按现有能力渐进补齐

退出条件：

- 新增接口都有明确处理路径（实现或受控降级）
- 前端不出现未拦截请求导致的硬失败

## 2.5 阶段 E：联调验证与收尾

任务：

1. 执行完整验证矩阵（见 `05-validation-risk-rollback.md`）
2. 更新 docs（前端指南、后端结构、实施计划）
3. 产出同步总结（变更范围、未完成项、后续计划）

退出条件：

- 关键功能回归通过
- 文档与实际代码一致

## 3. 交付拆分建议

1. PR-1：工具 + 报告（不动业务逻辑）
2. PR-2：无冲突文件批量同步
3. PR-3：P0 冲突合并（入口与主链）
4. PR-4：P1/P2 冲突 + 接口契约补齐
5. PR-5：测试补齐与文档更新

## 4. 本轮状态

当前仅完成“阶段 A 的计划设计”，尚未进入代码实现。

